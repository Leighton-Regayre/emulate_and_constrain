 This folder
/nfs/a134/mm11lr/constraint/

contains all of the output folders from the constraint process

The folder /R_code_for_constraint/
constains relevlant codes.

and some dependent codes are here:
/nfs/see-fs-01_users/earjsj/CSSP/UKCA_LargePPE_Jan15/EmulationSA_Codes/JJCode_RealObsConstraint_CSSP/

######################
## 26aer/27aeratm
## LSUnif/LSPrior
######################

Codes have been adapted to fit the PPE-specific and LargeSample-specific criteria


######################################
## CONSTRAINT STEPS
## assumes already in /nfs/a134/mm11lr/constraint/
######################################

1/ Copy combined PPE member .nc files from Jasmin to "/observations_PPEmembers_datafiles/"
2/ Check observation data is stored correctly here as a table: "/obsID_gblocation_infotables/"
3/ Run <CHECK ALTERNATIVE BELOW> "RunCode_Calculate_ImplausMeasure_NMAEF_NMBF_2627_LSUnifLSPrior_code_embedded.r"
   which makes all required folders, removes netcdf files, emulates, calculates implausibility and NMABE

3/ <ALTERNATIVE> Region specific alternative for cdn and aod slopes. 
    "RunCode_Calculate_ImplausMeasure_NMAEF_NMBF_2627_LSUnifLSPrior_code_embedded_CDN_AOD_specific.r"

4/ Want to emulate variables to apply constraint to? (ONCE ONLY PER MONTH)
       Extract annual/regional means for ensemble members using /nfs/a134/mm11lr/python/constraint/calculate_global_means_26aer.py (or equvalent), 
       then run this: "RunCode_Emulate_Predict_VarsApplyConstraintsTo_unif_switch.r"

5/ Make a table of implausibility metrics using "RunCode_ApplyImplausibility_TholdTol_AllCode_unif_switch.r"
6/ Run "JJCode_MakePlots_ExploreImplausOutput_unif_switch.r"
7/ Run "JJCode_MakePlots_ObservationsPlots_unif_switch.r"
8/ <CHECK ALTERNATIVE BELOW> Postage stamps and Marginal parameter space plots: Run "JJCode_MakePlots_ThreshTolConOnVars_DensOverVars_ParSpaceDens_unif_switch.r"

8/ <ALTERNATIVE> Python: /nfs/a134/mm11lr/python/constraint/marginal_parameters_post_constraint.py

9/ Run "JJCode_MakePlots_NMAEF_NMBF_unif_switch.r"

###########################################
## Plotting alternatives ONCE THESH/TOL choices are made
## for COMBINED CONSTRAINTS
## Can make use of multi-constraint if available.
###########################################

Plot marginal densities over all months using prescribed choices of th/tol
10/ <CHECK ALTERNATIVE> "JJCode_MakePlots_IndivMthChoiceSet_MargParSpaceDens.r"

10/ <ALTERNATIVE> Python: /nfs/a134/mm11lr/python/constraint/marginal_parameters_post_combined_constraint.py

Plot marginal densities over all months for INDIVIDUAL PARAMETERS (warning not to include the multi-constraint)
11/ "JJCode_MakePlots_ByParameter_IndivMthChoiceSet_MultiCon_MargParSpaceDens.r"


#################################################################
ALT PLOTTING: of constrained space compared to full sample emulated space over all gridboxes
#################################################################

Alt1/ Extract individual sample using "/nfs/a134/mm11lr/python/constraint/Extract_constrained_sample.py"
Alt2/ Run individual gridbox emulation of relevant variable on JASMIN
Alt3/ Overlay observations and multiple samples using "/nfs/a134/mm11lr/python/acure/constraint/map_mean_sd_PPE_overlaid_w_obs_constrained_and_unconstrained.py"

#################################################################
# MULTIPLE CONSTRAINED SAMPLES COMBINED
#################################################################

Comb 1/ In python, run "/nfs/a134/mm11lr/constraint/Extract_multi_obs_constrained_samples_ACTRIS.py" (or simialr) to produce subsamples from multiple constraints.
Comb2/ Run "/nfs/a134/mm11lr/constraint/R_code_for_constraint/JJCode_MakePlots_ThreshTolConOnVars_DensOverVars_ParSpaceDens_unif_switch_combined_constraints.r"
to make marginal parameter plots of any subsample netcdf file.

#######################
## Folder descriptions
#######################

## observations_PPEmembers_datafiles/
contains .nc data files copied from MY on JASMIN

## emulator_validation/
contains tables of validation statistics as well as validation plots

## fitted_emulator_models/
has the EMULATORS which can be read in and used again for consistency.

## predict_emulator_obsconstrain/
has .pdf and .nc files
the .pdf files show the sample histograms with mean and observed values as vertical lines
the .nc files have sample statistics (percentiles, min, max, etc.)


## predict_emulator_varsapplyconstraintto/
contains the files made with 'RunCode_Emulate_Predict_VarsApplyConstraintsTo'
that contain forcing values for the sample.
All netCDF data are Variables


## implausibility_measure_outputdata/
contains the implausibility metrics for each model variant/observation combination


## NMAEF_NMBF_outputdata/
has the Normalised Mean Average Error Factors
and the Normalised Mean Bias Factors
for each model variant/observation


## core_code_copy/
contains copies of JJs code used to test full code implementation
TESTING ONLY, except where paths are specific to LSUnif/LSPrior, etc.


## obsID_gblocation_infotables/
has the raw observational data used to constrain
Files have index, ObsValue, LonIndex, LatIndex, LonActual, LatActual
where the lat/lon indices and actual values match the netCDF data structure of our simulated output
For ACE-SPACE these were made using
/nfs/a134/mm11lr/python/acespace/CCN_convert_to_netcdf_and_dat.py
for example


## plotting_implausibility_values/
has figures

## SAres_varsapplyconstraintto/
Main effects and sensitivity output
Made seperately using 'RunCode_Emulate_Predict_VarsApplyConstraintsTo.r'

This is global, annual mean data of output variables to be constrained.

## apply_implausibility_tholdtol_RRinddata/
UNSURE

###############################
## Emulating, sampling and implausibility
###############################

The code 'RunCode_Calculate_ImplausMeasure_NMAEF_NMBF.r'
has options to make/read emulators, sample and predicted values (MUCH quicker to read in predicted values)

Emulator and predicted sample might be read in if the uncertainty terms change
1/ Observational
2/ Spatial colocation
3/ Temporal colocation
4/ Structural
because then only the implausilbility metrics will be changed.


########################
## Large Sample for constraint
########################

THERE ARE 2 VERSIONS OF THE LARGE SAMPLE. BOTH ARE BEING USED.

1/ PRIOR
This is read using
LS_FilePath = "/nfs/a173/earjsj/UM-UKCA_vn8.4_PPEs/27aeratm/regional_synthetic_constraint/largeinputsamples/SingleRLHS_size1M/RLHSamp_1Mcombs_MargDistsApp_Sample1.nc"

This file has dependencies on files within JJs core_code folder
/nfs/see-fs-01_users/earjsj/CSSP/UKCA_LargePPE_Jan15/EmulationSA_Codes/JJCode_RealObsConstraint_CSSP/

Each section of the code (emulation, sample, prediction) has an equvalent file which pre-dates this one and
performs seperate tasks.


2/ UNCONSTRAINED/UNIFORM
ls_fILEpATH = "j/UM-UKCA_vn8.4_PPEs/27aeratm/regional_synthetic_constraint/largeinputsamples/SingleRLHS_size1M/ RLHSamp_1Mcombs_MargUnif_Sample1.nc"


####################################
## Global mean forcing emulation w same sample
####################################

The file
'RunCode_Emulate_Predict_VarsApplyConstraintsTo.r'
emulates 1850-2008 aerosol ERF and samples at the same 1M points as used for observed values
as well as forcing terms (ARI, ACI, clear-ARI)

The resulting netCDF file combines observed and the forcing values into a single netCDF

Output files are stored in 
predict_emulator_varsapplyconstraintto/
and look like:
"LSPred_AWglobalavg_CCN0p2VL1_PIPD_jan.nc"


#####################################
## Apply implausibility thresholds
#####################################

The file
'RunCode_ApplyImplausibility_TholdTol.r'
makes an array/table of 1M * 3D implausibility metrics.
i.e. Every model variant has 3 implausibility metrics.

The table is labelled 'RetainRejectIndex'

This is used by plotting code to summarise implausibility features
NOTE: A newer version of this code exists which uses retained percentage (prescribed)
to calculate exceedence tolerance as a dependent term. Included in current version.


## ALTERNATIVE file

'RunCode_ApplyImplausibility_TholdTol_AllCode.r'

now includes the dependent functions, which were previously
stored in JJ's R folder.


###################################
## Plot implausibility for every observation
###################################

'JJCode_MakePlots_ExploreImplausOutput.r'
takes implausibility output, generates statistics and plots for every observation

Take care with Ylmin/max to alter the maximum implausiblity on the axis.

NOTE: Make the maximum exceedance larger than in my data.
This is coded up but has potential to make a single observation skew the retained distribution

PageObsRanges can be used to fix the number of plotted lines per page.


#############################################
## Extract sample for emulation in individual gridboxes on Jasmin
#############################################

'/nfs/a134/mm11lr/python/constraint/Extract_constrained_sample.py'

uses the implausibility matricies, an extracts samples for each tolerance/threshold combination.


